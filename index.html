<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Price Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.17/dist/scittle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .crypto-card { 
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .crypto-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .crypto-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .crypto-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .price { 
            font-size: 1.8em; 
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 0.75em;
            color: #718096;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 0.95em;
            font-weight: 600;
            color: #2d3748;
        }
        
        .change-positive { color: #48bb78; }
        .change-negative { color: #f56565; }
        
        .loading { 
            text-align: center;
            color: white;
            font-size: 1.2em;
        }
        
        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .last-update {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
        }
        
        @media (max-width: 640px) {
            h1 { font-size: 1.8em; }
            .crypto-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíé Crypto Price Dashboard</h1>
        <div id="app">
            <div class="loading">‚è≥ Loading crypto data...</div>
        </div>
    </div>

    <script type="application/x-scittle">
        (ns crypto-app
          (:require [clojure.string :as str]))

        (def app-state (atom {:prices {} :last-update nil :loading true :error nil}))

        ;; Crypto icons mapping
        (def crypto-icons
          {:bitcoin "‚Çø"
           :ethereum "Œû"
           :cardano "‚Ç≥"
           :polkadot "‚óè"
           :chainlink "‚¨°"
           :solana "‚óé"
           :avalanche-2 "üî∫"
           :polygon "‚ñ≤"})

        (defn format-number [n decimals]
          (.toLocaleString n "en-US" 
            #js{:minimumFractionDigits decimals 
                :maximumFractionDigits decimals}))

        (defn format-price [price]
          (str "$" (format-number price 2)))

        (defn format-volume [vol]
          (cond
            (>= vol 1e9) (str "$" (format-number (/ vol 1e9) 2) "B")
            (>= vol 1e6) (str "$" (format-number (/ vol 1e6) 2) "M")
            :else (str "$" (format-number vol 0))))

        (defn format-market-cap [cap]
          (format-volume cap))

        (defn format-change [change]
          (let [formatted (str (if (>= change 0) "+" "") 
                              (format-number change 2) "%")
                class (if (>= change 0) "change-positive" "change-negative")]
            [:span {:class class} formatted]))

        (defn crypto-card [crypto-id data]
          (let [name (-> crypto-id name (str/replace "-" " ") str/capitalize)
                icon (get crypto-icons (keyword crypto-id) "ü™ô")
                price (get data "usd")
                change (get data "usd_24h_change")
                volume (get data "usd_24h_vol")
                market-cap (get data "usd_market_cap")]
            [:div {:class "crypto-card"}
             [:div {:class "crypto-header"}
              [:div {:class "crypto-icon"} icon]
              [:div {:class "crypto-name"} name]]
             [:div {:class "price"} (format-price price)]
             [:div "24h Change: " (format-change change)]
             [:div {:class "stats"}
              [:div {:class "stat"}
               [:div {:class "stat-label"} "24h Volume"]
               [:div {:class "stat-value"} (format-volume volume)]]
              [:div {:class "stat"}
               [:div {:class "stat-label"} "Market Cap"]
               [:div {:class "stat-value"} (format-market-cap market-cap)]]]]))

        (defn app-component []
          (let [{:keys [prices last-update loading error]} @app-state]
            [:div
             (cond
               error [:div {:class "error"} 
                      "‚ùå Error loading data: " error 
                      [:br]
                      "Will retry in 30 seconds..."]
               loading [:div {:class "loading"} "‚è≥ Loading crypto data..."]
               :else [:div
                      [:div {:class "crypto-grid"}
                       (for [[crypto-id data] prices]
                         ^{:key crypto-id} [crypto-card crypto-id data])]
                      (when last-update
                        [:div {:class "footer"}
                         [:div {:class "last-update"}
                          "üìä Last updated: " last-update]])])]))

        (defn fetch-crypto-data []
          (swap! app-state assoc :loading true :error nil)
          (-> (js/fetch "./data/crypto-prices.json")
              (.then (fn [response]
                       (if (.-ok response)
                         (.json response)
                         (throw (js/Error. (str "HTTP " (.-status response)))))))
              (.then (fn [data]
                       (let [js-data (js->clj data)
                             prices (dissoc js-data "timestamp" "source" "last_update")
                             last-update (get js-data "last_update")]
                         (swap! app-state assoc 
                                :prices prices 
                                :last-update last-update 
                                :loading false
                                :error nil))))
              (.catch (fn [error]
                        (js/console.error "Failed to fetch crypto data:" error)
                        (swap! app-state assoc 
                               :loading false 
                               :error (.-message error))))))

        ;; Simple rendering function
        (defn render-to-string [component]
          (cond
            (vector? component)
            (let [[tag & args] component
                  has-attrs? (map? (first args))
                  attrs (if has-attrs? (first args) {})
                  children (if has-attrs? (rest args) args)
                  attrs-str (str/join " " 
                              (map (fn [[k v]] 
                                    (str (name k) "=\"" v "\"")) 
                                   attrs))]
              (str "<" (name tag) 
                   (when (seq attrs-str) (str " " attrs-str)) ">"
                   (str/join "" (map render-to-string children))
                   "</" (name tag) ">"))
            
            (string? component) component
            (number? component) (str component)
            :else (str component)))

        (defn update-dom []
          (let [app-element (js/document.getElementById "app")]
            (set! (.-innerHTML app-element) 
                  (render-to-string (app-component)))))

        ;; Initialize app
        (add-watch app-state :dom-update 
                   (fn [_ _ _ _] (update-dom)))

        ;; Fetch data immediately and then every 30 seconds
        (fetch-crypto-data)
        (js/setInterval fetch-crypto-data 30000)
    </script>
</body>
</html>